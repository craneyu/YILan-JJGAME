<div class="min-h-screen p-4">
  <!-- 頁首 -->
  <div class="glass-card px-6 py-3 mb-4 flex items-center justify-between">
    <div class="flex items-center gap-2">
      <fa-icon [icon]="faUserShield" class="text-blue-400"></fa-icon>
      <span class="text-white font-bold">管理員</span>
    </div>
    <h1 class="text-white font-medium">柔術競賽演武計分平台</h1>
    <button class="glass-btn text-sm" (click)="logout()">登出</button>
  </div>

  <!-- 裁判管理摺疊區 -->
  <div class="glass-card p-4 mb-4">
    <button class="w-full flex items-center justify-between" (click)="showJudges.set(!showJudges())">
      <div class="flex items-center gap-2">
        <fa-icon [icon]="faUsers" class="text-blue-400"></fa-icon>
        <span class="text-white font-semibold">裁判帳號管理 / 指派賽事</span>
        <span class="text-white/40 text-xs ml-1">（{{ judges().length }} 位）</span>
      </div>
      <span class="text-white/40 text-sm">{{ showJudges() ? '▲' : '▼' }}</span>
    </button>

    @if (showJudges()) {
      <div class="mt-4 overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-white/50 text-xs border-b border-white/10">
              <th class="text-left py-2 pr-3">帳號</th>
              <th class="text-left py-2 pr-3">角色</th>
              <th class="text-left py-2 pr-3">目前指派賽事</th>
              <th class="text-left py-2 pr-3">指派到賽事</th>
              <th class="text-left py-2">操作</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-white/5">
            @for (judge of judges(); track judge._id) {
              <tr class="text-white/80">
                <td class="py-2 pr-3 font-medium">{{ judge.username }}</td>
                <td class="py-2 pr-3 text-white/50 text-xs">
                  {{ judge.role === 'scoring_judge' ? '計分裁判 #' + judge.judgeNo
                   : judge.role === 'sequence_judge' ? '賽序裁判'
                   : judge.role === 'vr_judge' ? 'VR 裁判'
                   : judge.role === 'admin' ? '管理員'
                   : judge.role }}
                </td>
                <td class="py-2 pr-3">
                  @if (judge.eventId) {
                    <span class="text-green-400 text-xs">{{ judge.eventId.name }}</span>
                  } @else {
                    <span class="text-white/30 text-xs">未指派</span>
                  }
                </td>
                <td class="py-2 pr-3">
                  @if (judge.role !== 'admin') {
                    <select class="bg-white/10 text-white text-xs border border-white/20 rounded px-2 py-1 outline-none focus:border-blue-400"
                      [value]="judge.eventId?._id ?? ''"
                      (change)="assignJudgeEvent(judge._id, $any($event.target).value)">
                      <option value="" class="bg-slate-800">— 取消指派 —</option>
                      @for (event of events(); track event._id) {
                        <option [value]="event._id" class="bg-slate-800">{{ event.name }}</option>
                      }
                    </select>
                  }
                </td>
                <td class="py-2">
                  <button class="flex items-center gap-1 text-xs text-yellow-400/80 hover:text-yellow-300 border border-yellow-400/30 hover:border-yellow-300/60 rounded-lg px-2 py-1 transition-colors"
                    (click)="changePassword(judge)" title="變更密碼">
                    <fa-icon [icon]="faKey" class="text-xs"></fa-icon> 改密碼
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- 左側：賽事管理 -->
    <div class="glass-card p-5">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-white font-semibold text-lg">賽事管理</h2>
        <button class="primary-btn text-sm flex items-center gap-1" (click)="showCreateEvent.set(!showCreateEvent())">
          <fa-icon [icon]="faPlus"></fa-icon> 新增
        </button>
      </div>

      <!-- 建立賽事表單 -->
      @if (showCreateEvent()) {
        <div class="bg-white/5 border border-white/20 rounded-xl p-4 mb-4 space-y-3">
          <input type="text" [(ngModel)]="newEvent.name" placeholder="賽事名稱*"
            class="w-full bg-white/10 text-white border border-white/30 rounded-lg px-3 py-2 outline-none focus:border-blue-400 placeholder:text-white/30" />
          <input type="date" [(ngModel)]="newEvent.date"
            class="w-full bg-white/10 text-white border border-white/30 rounded-lg px-3 py-2 outline-none focus:border-blue-400" />
          <input type="text" [(ngModel)]="newEvent.venue" placeholder="場地"
            class="w-full bg-white/10 text-white border border-white/30 rounded-lg px-3 py-2 outline-none focus:border-blue-400 placeholder:text-white/30" />
          <div class="flex gap-2">
            <button class="primary-btn flex-1" (click)="createEvent()">確認建立</button>
            <button class="glass-btn" (click)="showCreateEvent.set(false)">取消</button>
          </div>
        </div>
      }

      <!-- 賽事列表 -->
      <div class="space-y-2 max-h-80 overflow-y-auto">
        @for (event of events(); track event._id) {
          @if (editingEventId() !== event._id) {
            <!-- 一般顯示列 -->
            <div class="flex items-center gap-2 p-3 rounded-xl transition-all cursor-pointer"
              [class]="selectedEvent()?._id === event._id ? 'bg-blue-500/30 border border-blue-400/50' : 'bg-white/5 border border-white/10 hover:bg-white/10'"
              (click)="selectEvent(event)">
              <div class="flex-1 min-w-0">
                <p class="text-white font-medium truncate">{{ event.name }}</p>
                <div class="flex items-center gap-2 mt-0.5">
                  <span class="text-xs px-1.5 py-0.5 rounded-full"
                    [class]="event.status === 'active'  ? 'bg-green-500/20 text-green-400'
                            : event.status === 'closed' ? 'bg-red-500/20 text-red-400'
                            : 'bg-white/10 text-white/50'">
                    {{ event.status === 'active' ? '進行中' : event.status === 'closed' ? '已關閉' : '準備中' }}
                  </span>
                  @if (event.date) {
                    <span class="text-white/30 text-xs">{{ event.date | date:'MM/dd' }}</span>
                  }
                </div>
              </div>
              <div class="flex gap-0.5 flex-shrink-0">
                <button class="text-blue-400/60 hover:text-blue-400 transition-colors p-1.5 rounded-lg hover:bg-white/5"
                  (click)="$event.stopPropagation(); startEditEvent(event)" title="編輯">
                  <fa-icon [icon]="faPen" class="text-xs"></fa-icon>
                </button>
                @if (event.status !== 'closed') {
                  <button class="text-red-400/60 hover:text-red-400 transition-colors p-1.5 rounded-lg hover:bg-white/5"
                    (click)="$event.stopPropagation(); closeEvent(event)" title="關閉賽事">
                    <fa-icon [icon]="faLock" class="text-xs"></fa-icon>
                  </button>
                }
                <button class="text-red-500/70 hover:text-red-400 transition-colors p-1.5 rounded-lg hover:bg-red-500/10"
                  (click)="$event.stopPropagation(); deleteEvent(event)" title="刪除賽事">
                  <fa-icon [icon]="faTrash" class="text-xs"></fa-icon>
                </button>
              </div>
            </div>
          } @else {
            <!-- 編輯 inline 表單 -->
            <div class="bg-blue-500/10 border border-blue-400/40 rounded-xl p-3 space-y-2">
              <div class="flex items-center justify-between">
                <span class="text-blue-300 text-sm font-medium">編輯賽事</span>
                <button class="text-white/40 hover:text-white/70 transition-colors" (click)="cancelEditEvent()">
                  <fa-icon [icon]="faXmark"></fa-icon>
                </button>
              </div>
              <input type="text" [(ngModel)]="editEventForm.name" placeholder="賽事名稱*"
                class="w-full bg-white/10 text-white border border-white/30 rounded-lg px-3 py-1.5 text-sm outline-none focus:border-blue-400 placeholder:text-white/30" />
              <div class="grid grid-cols-2 gap-2">
                <input type="date" [(ngModel)]="editEventForm.date"
                  class="bg-white/10 text-white border border-white/30 rounded-lg px-3 py-1.5 text-sm outline-none focus:border-blue-400" />
                <input type="text" [(ngModel)]="editEventForm.venue" placeholder="場地"
                  class="bg-white/10 text-white border border-white/30 rounded-lg px-3 py-1.5 text-sm outline-none focus:border-blue-400 placeholder:text-white/30" />
              </div>
              <select [(ngModel)]="editEventForm.status"
                class="w-full bg-white/10 text-white border border-white/30 rounded-lg px-3 py-1.5 text-sm outline-none focus:border-blue-400">
                <option value="pending" class="bg-slate-800">準備中</option>
                <option value="active" class="bg-slate-800">進行中</option>
                <option value="closed" class="bg-slate-800">已關閉</option>
              </select>
              <div class="flex gap-2">
                <button class="primary-btn flex-1 flex items-center justify-center gap-1 text-sm py-1.5" (click)="saveEditEvent(event)">
                  <fa-icon [icon]="faCheck"></fa-icon> 儲存
                </button>
                <button class="glass-btn text-sm py-1.5" (click)="cancelEditEvent()">取消</button>
              </div>
            </div>
          }
        }
        @empty {
          <p class="text-white/40 text-center py-4">尚無賽事</p>
        }
      </div>
    </div>

    <!-- 右側：隊伍管理 -->
    <div class="glass-card p-5">
      @if (selectedEvent()) {
        <!-- 標題列 + 操作按鈕 -->
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-white font-semibold text-lg">{{ selectedEvent()!.name }} - 隊伍</h2>
          @if (!reorderMode()) {
            <div class="flex gap-2">
              <label class="primary-btn text-sm flex items-center gap-1 cursor-pointer">
                <fa-icon [icon]="faFileArrowUp"></fa-icon> 匯入
                <input type="file" accept=".xlsx,.csv" class="hidden" (change)="importFile($event)" />
              </label>
              <button class="primary-btn text-sm flex items-center gap-1" (click)="showAddTeam.set(!showAddTeam())">
                <fa-icon [icon]="faPlus"></fa-icon> 新增
              </button>
            </div>
          }
        </div>

        <!-- 新增隊伍表單 -->
        @if (showAddTeam()) {
          <div class="bg-white/5 border border-white/20 rounded-xl p-4 mb-3 space-y-3">
            <input type="text" [(ngModel)]="newTeam.name" placeholder="隊伍名稱*"
              class="w-full bg-white/10 text-white border border-white/30 rounded-lg px-3 py-2 outline-none focus:border-blue-400 placeholder:text-white/30" />
            <div class="grid grid-cols-2 gap-2">
              <input type="text" [(ngModel)]="newTeam.member1" placeholder="隊員一*"
                class="bg-white/10 text-white border border-white/30 rounded-lg px-3 py-2 outline-none focus:border-blue-400 placeholder:text-white/30" />
              <input type="text" [(ngModel)]="newTeam.member2" placeholder="隊員二"
                class="bg-white/10 text-white border border-white/30 rounded-lg px-3 py-2 outline-none focus:border-blue-400 placeholder:text-white/30" />
            </div>
            <div class="grid grid-cols-2 gap-2">
              <select [(ngModel)]="newTeam.category"
                class="bg-white/10 text-white border border-white/30 rounded-lg px-3 py-2 outline-none focus:border-blue-400">
                <option value="male" class="bg-slate-800">男子組</option>
                <option value="female" class="bg-slate-800">女子組</option>
                <option value="mixed" class="bg-slate-800">混合組</option>
              </select>
              <input type="number" [(ngModel)]="newTeam.order" placeholder="賽程場次"
                class="bg-white/10 text-white border border-white/30 rounded-lg px-3 py-2 outline-none focus:border-blue-400" />
            </div>
            <div class="flex gap-2">
              <button class="primary-btn flex-1" (click)="addTeam()">確認新增</button>
              <button class="glass-btn" (click)="showAddTeam.set(false)">取消</button>
            </div>
          </div>
        }

        <!-- 類別篩選分頁 -->
        @if (teams().length > 0) {
          <div class="flex gap-1 mb-3 bg-white/5 rounded-xl p-1">
            @for (tab of [
              { key: 'all',    label: '全部',   count: teamCounts().all    },
              { key: 'male',   label: '男子組', count: teamCounts().male   },
              { key: 'female', label: '女子組', count: teamCounts().female },
              { key: 'mixed',  label: '混合組', count: teamCounts().mixed  }
            ]; track tab.key) {
              @if (tab.key === 'all' || tab.count > 0) {
                <button
                  class="flex-1 text-xs py-1.5 px-2 rounded-lg transition-all"
                  [class]="teamFilter() === tab.key
                    ? 'bg-blue-500/80 text-white font-medium'
                    : 'text-white/50 hover:text-white/80'"
                  (click)="teamFilter.set($any(tab.key))">
                  {{ tab.label }}
                  <span class="ml-1 opacity-70">{{ tab.count }}</span>
                </button>
              }
            }
          </div>
        }

        <!-- 工具列：排序模式 / 一般批次操作 -->
        @if (filteredTeams().length > 0) {
          @if (reorderMode()) {
            <!-- 排序模式工具列 -->
            <div class="flex items-center gap-2 px-1 mb-2 py-1.5 bg-yellow-500/10 border border-yellow-400/20 rounded-xl">
              <fa-icon [icon]="faSort" class="text-yellow-400 text-sm ml-1"></fa-icon>
              <span class="text-yellow-300 text-xs font-medium flex-1">設定場次中</span>
              <button class="flex items-center gap-1 text-xs text-white/60 hover:text-white/90 border border-white/20 hover:border-white/40 rounded-lg px-2 py-1 transition-colors"
                (click)="autoNumber()">
                自動編號
              </button>
              <button class="flex items-center gap-1 text-xs text-green-400 hover:text-green-300 border border-green-400/40 hover:border-green-300/60 rounded-lg px-2 py-1 transition-colors"
                (click)="saveReorder()">
                <fa-icon [icon]="faCheck" class="text-xs"></fa-icon> 儲存場次
              </button>
              <button class="flex items-center gap-1 text-xs text-white/50 hover:text-white/80 border border-white/20 hover:border-white/40 rounded-lg px-2 py-1 transition-colors"
                (click)="cancelReorderMode()">
                取消
              </button>
            </div>
          } @else {
            <!-- 一般批次工具列 -->
            <div class="flex items-center gap-3 px-1 mb-2">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" [checked]="allSelected()" (change)="toggleSelectAll()"
                  class="w-4 h-4 accent-blue-500 cursor-pointer" />
                <span class="text-white/50 text-xs">全選</span>
              </label>
              @if (selectedTeamIds().size > 0) {
                <div class="flex items-center gap-2">
                  <span class="text-blue-300 text-xs">已選 {{ selectedTeamIds().size }} 筆</span>
                  <button class="flex items-center gap-1 text-xs text-red-400 hover:text-red-300 border border-red-400/40 hover:border-red-300/60 rounded-lg px-2 py-1 transition-colors"
                    (click)="batchDeleteTeams()">
                    <fa-icon [icon]="faTrash" class="text-xs"></fa-icon> 批次刪除
                  </button>
                </div>
              }
              <button class="ml-auto flex items-center gap-1 text-xs text-yellow-400/80 hover:text-yellow-300 border border-yellow-400/30 hover:border-yellow-300/60 rounded-lg px-2 py-1 transition-colors"
                (click)="enterReorderMode()">
                <fa-icon [icon]="faSort" class="text-xs"></fa-icon> 設定場次
              </button>
            </div>
          }
        }

        <!-- 隊伍列表 -->
        <div class="space-y-2 max-h-[28rem] overflow-y-auto">
          @for (team of filteredTeams(); track team._id) {
            @if (reorderMode()) {
              <!-- 排序模式卡片：場次可直接輸入 -->
              <div class="flex items-center gap-3 p-3 rounded-xl bg-yellow-500/5 border border-yellow-400/20">
                <input type="number" min="1"
                  [value]="reorderMap()[team._id]"
                  (input)="setReorderValue(team._id, +$any($event.target).value)"
                  class="w-14 bg-white/10 text-white text-center font-bold text-sm border border-yellow-400/40 rounded-lg px-1 py-1.5 outline-none focus:border-yellow-400 flex-shrink-0" />
                <div class="flex-1 min-w-0">
                  <p class="text-white font-medium truncate">{{ team.name }}</p>
                  <p class="text-white/50 text-xs truncate">{{ team.members.join(' / ') }}</p>
                </div>
                @if (teamFilter() === 'all') {
                  <span class="text-xs px-1.5 py-0.5 rounded-full flex-shrink-0"
                    [class]="team.category === 'male' ? 'bg-blue-500/20 text-blue-300'
                            : team.category === 'female' ? 'bg-pink-500/20 text-pink-300'
                            : 'bg-purple-500/20 text-purple-300'">
                    {{ team.category === 'male' ? '男' : team.category === 'female' ? '女' : '混' }}
                  </span>
                }
              </div>
            } @else if (editingTeamId() !== team._id) {
              <!-- 一般顯示列 -->
              <div class="flex items-center gap-2 p-3 rounded-xl bg-white/5 border border-white/10">
                <input type="checkbox" [checked]="selectedTeamIds().has(team._id)"
                  (change)="toggleSelectTeam(team._id)"
                  class="w-4 h-4 accent-blue-500 cursor-pointer flex-shrink-0" />
                <!-- 場次徽章 -->
                <div class="flex-shrink-0 w-9 h-9 rounded-lg bg-white/10 border border-white/20 flex flex-col items-center justify-center">
                  <span class="text-white/40 text-[9px] leading-none">場次</span>
                  <span class="text-white font-bold text-sm leading-tight">{{ team.order }}</span>
                </div>
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2">
                    <p class="text-white font-medium truncate">{{ team.name }}</p>
                    @if (teamFilter() === 'all') {
                      <span class="text-xs px-1.5 py-0.5 rounded-full flex-shrink-0"
                        [class]="team.category === 'male' ? 'bg-blue-500/20 text-blue-300'
                                : team.category === 'female' ? 'bg-pink-500/20 text-pink-300'
                                : 'bg-purple-500/20 text-purple-300'">
                        {{ team.category === 'male' ? '男' : team.category === 'female' ? '女' : '混' }}
                      </span>
                    }
                  </div>
                  <p class="text-white/60 text-sm truncate">{{ team.members.join(' / ') }}</p>
                </div>
                <div class="flex gap-1 flex-shrink-0">
                  <button class="text-blue-400/70 hover:text-blue-400 transition-colors p-2"
                    (click)="startEdit(team)" title="編輯">
                    <fa-icon [icon]="faPen"></fa-icon>
                  </button>
                  <button class="text-red-400/70 hover:text-red-400 transition-colors p-2"
                    (click)="deleteTeam(team)" title="刪除">
                    <fa-icon [icon]="faTrash"></fa-icon>
                  </button>
                </div>
              </div>
            } @else {
              <!-- 編輯 inline 表單 -->
              <div class="bg-blue-500/10 border border-blue-400/40 rounded-xl p-4 space-y-3">
                <div class="flex items-center justify-between mb-1">
                  <span class="text-blue-300 text-sm font-medium">編輯隊伍</span>
                  <button class="text-white/40 hover:text-white/70 transition-colors" (click)="cancelEdit()">
                    <fa-icon [icon]="faXmark"></fa-icon>
                  </button>
                </div>
                <input type="text" [(ngModel)]="editForm.name" placeholder="隊伍名稱*"
                  class="w-full bg-white/10 text-white border border-white/30 rounded-lg px-3 py-2 outline-none focus:border-blue-400 placeholder:text-white/30" />
                <div class="grid grid-cols-2 gap-2">
                  <input type="text" [(ngModel)]="editForm.member1" placeholder="隊員一*"
                    class="bg-white/10 text-white border border-white/30 rounded-lg px-3 py-2 outline-none focus:border-blue-400 placeholder:text-white/30" />
                  <input type="text" [(ngModel)]="editForm.member2" placeholder="隊員二"
                    class="bg-white/10 text-white border border-white/30 rounded-lg px-3 py-2 outline-none focus:border-blue-400 placeholder:text-white/30" />
                </div>
                <div class="grid grid-cols-2 gap-2">
                  <select [(ngModel)]="editForm.category"
                    class="bg-white/10 text-white border border-white/30 rounded-lg px-3 py-2 outline-none focus:border-blue-400">
                    <option value="male" class="bg-slate-800">男子組</option>
                    <option value="female" class="bg-slate-800">女子組</option>
                    <option value="mixed" class="bg-slate-800">混合組</option>
                  </select>
                  <input type="number" [(ngModel)]="editForm.order" placeholder="賽程場次"
                    class="bg-white/10 text-white border border-white/30 rounded-lg px-3 py-2 outline-none focus:border-blue-400" />
                </div>
                <div class="flex gap-2">
                  <button class="primary-btn flex-1 flex items-center justify-center gap-1" (click)="saveEdit(team)">
                    <fa-icon [icon]="faCheck"></fa-icon> 儲存
                  </button>
                  <button class="glass-btn" (click)="cancelEdit()">取消</button>
                </div>
              </div>
            }
          }
          @empty {
            @if (teams().length === 0) {
              <p class="text-white/40 text-center py-4">尚無隊伍，請新增或匯入</p>
            } @else {
              <p class="text-white/40 text-center py-4">此分組尚無隊伍</p>
            }
          }
        </div>
      } @else {
        <div class="h-full flex items-center justify-center">
          <p class="text-white/40">請先選擇賽事</p>
        </div>
      }
    </div>
  </div>
</div>
